---
title: "Estad칤stica y Econometr칤a Espacial con R, M칩dulo I"
subtitle: "Clase 4: "  
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    seal: false
    lib_dir: libs
    css: tema_ergos.css
    nature:
      highlightStyle: solarized-light
      highlightLines: true
      countIncrementalSlides: false
      tokenTransform:
        'functionCall': 'class="function-call"'
params: 
    background_img: "img/portada_nb.png"
    highlightStyle: solarized-light
---

class: title-slide center middle
background-image: url(`r params$background_img`)
background-size: 105%

## `r rmarkdown::metadata$title`
### `r rmarkdown::metadata$subtitle`

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Introducci칩n 

## Vecinos basados en contig칲idad 

- Se construyen asumiendo que los **vecinos de un 치rea determinada** son **otras 치reas** que comparten un **l칤mite com칰n**.
- **Reina (Queen):** dos unidades espaciales se consideran vecinas si comparten una frontera, un borde o un v칠rtice.
- **Torre (Rook):** dos unidades espaciales se consideran vecinas solo si comparten una frontera completa, es decir, solo los bordes horizontales o verticales, pero no los v칠rtices.

![](https://www.researchgate.net/publication/349718331/figure/fig3/AS:1013770432311298@1618713114930/Rooks-case-contiguity-and-queens-case-contiguity-Source-Reference-60.png)

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Vecinos basados en contig칲idad 

En R podemos usar la funci칩n `poly2nb` del paquete `spdep` para construir una **lista de vecinos** basados en una **distancia** entre **l칤mites inferiores y superiores** espec칤ficos. 

`poly2nb(pl, queen = TRUE)`
- `pl` lista de pol칤gonos.
- `queen = TRUE` condici칩n de contig칲idad.

```{r}
# Importamos las librer칤as necesarias 
library(spData)
library(sf)
library(spdep)
library(ggplot2)

# Cargamos el shapefile 
mapa <- st_read(system.file("shapes/columbus.shp",
               package = "spData"), quiet = TRUE)

# Obtenemos una lista de vecinos a partir de los poligonos
nb_con <- spdep::poly2nb(mapa, queen = TRUE)
head(nb_con)

# Visualizamos la lista de vecinos
plot(st_geometry(mapa), border = "lightgray")
plot.nb(nb_con, st_geometry(mapa), add = TRUE)

# Visualizamos los vecinos en base al criterio QUEEN 
id <- 20 # id del Area de Interes (AOI)
mapa$vecinos <- "otros"
mapa$vecinos[id] <- "AOI"
mapa$vecinos[nb_con[[id]]] <- "vecinos"
ggplot(mapa) + 
	geom_sf(aes(fill = vecinos)) + 
	theme_bw() +
		scale_fill_manual(values = c("gray30", "white", "gray"))
```

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Vecinos basados en distancia 

- Las vecindad tambi칠n pueden definirse **considerando las zonas vecinas** que se encuentran a una **distancia determinada**.

![](https://www.paulamoraga.com/book-spatial/book-spatial_files/figure-html/arealdata-neighborsdistance-1.png)

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Vecinos basados en distancia 
En R podemos usar la funci칩n `dnearneigh()` del paquete `spdep` para construir una **lista de vecinos**basados en una **distancia** entre **l칤mites inferiores y superiores** espec칤ficos. 

`dnearneigh(x, d1, d2)`
- `x` matriz de coordenadas de puntos.
- `d1` l칤mite inferior (km si son coordenadas geogr치ficas).
- `d2` l칤mite superior (km si son coordenadas geogr치ficas).

```{r}
# Determinamos los vecinos m치s cercanos dentro de una distancia dada 
nb_dis <- dnearneigh(x = st_centroid(mapa), d1 = 0, d2 = 0.4)

# Visualizamos los vecinos
plot(st_geometry(mapa), border = "lightgray")
plot.nb(nb_dis, st_geometry(mapa), add = TRUE)
```

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Vecinos basados en $k$ vecinos m치s cercanos

- Tambi칠n podemos considerar como **vecinos de una zona** sus$k$**vecinos m치s cercanos** en funci칩n de la **distancia que los separa**.
![](https://www.paulamoraga.com/book-spatial/book-spatial_files/figure-html/arealdata-neighborskneighbors-1.png)
--- 

background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left
## Vecinos basados en $k$ vecinos m치s cercanos

En R podemos usar la funci칩n `knearneigh()` del paquete `spdep` para obtener una **matriz** con los **칤ndices de los puntos** que pertenecen al **conjunto de los k vecinos m치s pr칩ximos** entre s칤.

`knearneigh(x, k = 1)`
- `x` matriz de coordenadas de puntos.
- `k = 1` n칰mero de vecinos m치s cercanos con los que trabajar. 

```{r}
# Obtenemos los 칤ndices de los puntos que 
# pertenecen al conjunto de los k vecinos m치s pr칩ximos entre s칤
ind <- knearneigh(st_centroid(mapa), k = 1)
  
# Obtenemos la lista de vecinos basados en estos indices 
nb_kvec <- knn2nb(ind) # k number nearest neighbors

# Visualizamos los vecinos 
plot(st_geometry(mapa), border = "lightgray")
plot.nb(nb_kvec, st_geometry(mapa), add = TRUE)

```

--- 

background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Matrices de vecindad 

- Una **matriz cuadrada** que representa las **relaciones espaciales** entre **diferentes unidades geogr치ficas**. 
- Cada **fila** y **columna** de la matriz corresponden a **una unidad espacial** (municipio, parcela de terreno) 
- Los **elementos de la matriz** indican la **relaci칩n** o la **proximidad** entre las **unidades**.

Adem치s, puede ser necesario ajustar el n칰mero total de vecinos en cada 치rea y usar una matriz estandarizada con entradas $w_{std, ij} = \frac{w_{ij}}{\sum_{j=1}^{n} w_{ij}}$.

Esto asegura:

1. Cada elemento de la matriz $洧녥{std}$ se encuentre entre 0 y 1.
2. Que la suma de cada una de sus filas sea siempre 1.

![](https://revistas.unal.edu.co/index.php/rcg/article/download/76919/version/61369/html/422727/v28n1a1f5.png)

--- 
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Matrices de vecindad 

La funci칩n `nb2listw()` del paquete `spdep` se puede utilizar para construir una **matriz de vecindad espacial** que contenga los **pesos espaciales correspondientes** a una **lista de vecinos**.

`nb2listw(nb, style, zero.policy)`

- **nb**: lista de vecinos.
- **style**: indica el esquema de codificaci칩n elegido. Por ejemplo, `style = "B"` es la codificaci칩n binaria b치sica, y `style = "W"` es estandarizada por fila (1/n칰mero de vecinos).
- **zero.policy**: se usa para tener en cuenta las regiones con 0 vecinos. Espec칤ficamente, `zero.policy = TRUE` permite que la lista de pesos contenga vectores de pesos de longitud cero, y `zero.policy = FALSE` detiene la funci칩n con un error si hay conjuntos de vecinos vac칤os.

```{r}
## Obtenemos la matriz de pesos espaciales 

# Para la matriz de vecinos por contig칲idad 
nbw_con <- spdep::nb2listw(nb_con, style = "W")
nbw_con$weights[1:3]

# Para la matriz de vecinos por distancia 
nbw_dis <- spdep::nb2listw(nb_dis, style = "W", zero.policy = TRUE)

# Para la matriz de k vecinos 
nbw_kvec <- spdep::nb2listw(nb_kvec, style = "W")

# Visualizamos la matriz de pesos espaciales 
# para la matriz de vecinos por contig칲idad 
m1 <- listw2mat(nbw_con)
lattice::levelplot(t(m1),
                   scales = list(y = list(at = seq(10, nrow(m1), by = 10),
                                          labels = seq(10, nrow(m1), by = 10))),
                   main = "Matriz de Pesos Espaciales Basada en Contig칲idad")
```

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## Autocorrelaci칩n espacial 

- Se utiliza para describir en qu칠 medida una variable est치 correlacionada consigo misma a trav칠s del espacio. 
- La autocorrelaci칩n espacial positiva se produce cuando las observaciones con valores similares est치n m치s pr칩ximas entre s칤 (es decir, agrupadas). 
- La autocorrelaci칩n espacial negativa se produce cuando las observaciones con valores distintos est치n m치s pr칩ximas entre s칤 (es decir, dispersas).

![](https://www.researchgate.net/publication/345326470/figure/fig4/AS:960053502804001@1605906000766/Conceptual-models-of-spatial-autocorrelation-Positive-spatial-autocorrelation-a-is.png)

- La autocorrelaci칩n espacial puede evaluarse utilizando 칤ndices que resumen el grado en que observaciones similares tienden a producirse cerca unas de otras en el 치rea de estudio. 
- Dos 칤ndices comunes que se utilizan para evaluar la autocorrelaci칩n espacial en datos areales son el **칤ndice global de Moran I y la C de Geary.**


---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice global de Moran I 

- Eval칰a si un patr칩n espacial de datos es aleatorio o si muestra alguna dependencia espacial. 
- Si los valores cercanos en el espacio son m치s similares entre s칤 de lo que se esperar칤a por azar.

El 칈ndice Global de Moran $I$ se calcula mediante la f칩rmula:

$$I = \frac{n \sum_i \sum_j w_{ij} (Y_i - \bar{Y}) (Y_j - \bar{Y})}{\left( \sum_{i \neq j} w_{ij} \right) \sum_i (Y_i - \bar{Y})^2}$$

Donde

- $n$ es el n칰mero total de regiones.
- $Y_i$ representa el valor observado de la variable de inter칠s en la regi칩n $i$.
- $\bar{Y}$ es la media de todos los valores.
- Los pesos espaciales $w_{ij}$ indican la proximidad espacial entre las regiones $i$ y $j$, con $w_{ii} = 0$ y $i, j = 1, \ldots, n$. La definici칩n de los pesos espaciales var칤a seg칰n la variable estudiada y el contexto espec칤fico.

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice global de Moran I 

### Interpretaci칩n del 칈ndice de Moran I:

- **Valor de Moran I cercano a +1**: Indica una **fuerte autocorrelaci칩n espacial positiva**, lo que significa que las ubicaciones con valores similares tienden a estar cerca unas de otras (agrupamiento espacial de valores similares).
- **Valor de Moran I cercano a -1**: Indica una **autocorrelaci칩n espacial negativa**, lo que significa que las ubicaciones con valores diferentes tienden a estar cerca (dispersi칩n espacial de valores dis칤miles).
- **Valor de Moran I cercano a 0**: Indica que no hay autocorrelaci칩n espacial, es decir, los valores se distribuyen de manera aleatoria en el espacio.

### Hip칩tesis del test de Moran I:

- $H_0$: No hay autocorrelaci칩n espacial (los valores est치n distribuidos aleatoriamente en el espacio).
- $H_1$: Hay autocorrelaci칩n espacial (los valores est치n agrupados o dispersos en el espacio).

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice global de Moran I 

En R la funci칩n `moran.test()` del paquete `spdep` permite evaluar la autocorrelaci칩n espacial utilizando el 칤ndice $I$ de Moran.

`moran.test(x, listw, alternative)`
- **x**: vector num칠rico con los datos.
- **listw**: lista con los pesos espaciales.
- **alternative**: indica el tipo de hip칩tesis y puede configurarse como `greater` (por defecto), `less` o `two.sided` para representar diferentes hip칩tesis alternativas.

```{r}
## Matriz de pesos espaciales

# Por contig칲idad 
nbw_con

# Por distancia 
nbw_dis

# Para la matriz de k vecinos 
nbw_kvec 

## Calculo de indice de global de moran 

# Contig칲idad
gmoran_con <- moran.test(mapa$CRIME, nbw_con, alternative = "greater")

# Distancia 
gmoran_dis <- moran.test(mapa$CRIME, nbw_dis, alternative = "greater")

# K vecinos
gmoran_kvec <- moran.test(mapa$CRIME, nbw_kvec,alternative = "greater")
```

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice C de Geary 

- Se enfoca en las **diferencias absolutas** entre los valores de una variable en ubicaciones geogr치ficas cercanas.
- Mide la disimilitud entre los valores de las ubicaciones vecinas.

$$ C(d) = \frac{(n-1) \sum_{i=1}^n \sum_{j=1}^n w_{ij}(x_i - x_j)^2}{2 \sum_{i=1}^n \sum_{j=1}^n w_{ij} \sum_{i=1}^n (x_i - \bar{x})^2} $$

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice C de Geary 
### Interpretaci칩n del 칈ndice C de Geary:

El 칤ndice C de Geary tiene un rango de valores entre **0** y **2**:

- **C < 1**: Indica **autocorrelaci칩n espacial positiva** (valores similares tienden a estar cerca entre s칤).
- **C = 1**: Indica que **no hay autocorrelaci칩n espacial** (los valores est치n distribuidos de manera aleatoria en el espacio).
- **C > 1**: Indica **autocorrelaci칩n espacial negativa** (valores dis칤miles tienden a estar cerca entre s칤).


---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

### Diferencias entre el 칈ndice de Moran I y el C de Geary:

Aunque ambos 칤ndices miden la autocorrelaci칩n espacial, hay algunas diferencias clave:

1. **Sensibilidad**:
    - **칈ndice de Moran I**: Se enfoca m치s en las covarianzas globales y es m치s sensible a la **autocorrelaci칩n global** (tendencias generales en el patr칩n espacial).
    - **C de Geary**: Es m치s sensible a las **variaciones locales** o a los valores at칤picos, ya que se basa en la disimilitud de las diferencias locales.
2. **Interpretaci칩n**:
    - **Moran I**: Los valores van de -1 (autocorrelaci칩n negativa) a +1 (autocorrelaci칩n positiva).
    - **C de Geary**: Va de 0 (fuerte autocorrelaci칩n positiva) a 2 (fuerte autocorrelaci칩n negativa), con un valor de 1 que indica no autocorrelaci칩n.

---
background-image: url(img/slide_nb.png)
background-position: top left
background-size: 140%
padding-top: 150px
class: top left

## 칈ndice C de Geary 

En R la funci칩n `geary.test()` del paquete `spdep` permite evaluar la autocorrelaci칩n espacial utilizando el 칤ndice $C$ de Geary.

`geary.test(x, listw, alternative)`
- **x**: vector num칠rico con los datos.
- **listw**: lista con los pesos espaciales.
- **alternative**: indica el tipo de hip칩tesis y puede configurarse como `greater` (por defecto), `less` o `two.sided` para representar diferentes hip칩tesis alternativas.

```{r}
## Matriz de pesos espaciales

# Por contig칲idad 
nbw_con

# Por distancia -
nbw_dis

# Para la matriz de k vecinos 
nbw_kvec 

## Calculo de indice de global de moran 

# Contig칲idad
geary_con <- geary.test(mapa$CRIME, nbw_con, alternative = "greater")

# Distancia 
geary_dis <- geary.test(mapa$CRIME, nbw_dis, alternative = "greater")

# K vecinos
geary_kvec <- geary.test(mapa$CRIME, nbw_kvec,alternative = "greater")
```

